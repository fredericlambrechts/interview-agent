# Story 3.1: n8n + ElevenLabs Foundation Setup

## Status
Draft

## Story
**As a** development team embracing visual workflow orchestration,
**I want** to establish the n8n and ElevenLabs infrastructure foundation,
**so that** we can build business logic visually without complex backend code

## Acceptance Criteria
1. n8n instance is running and accessible (cloud or self-hosted)
2. ElevenLabs Conversational AI account is active and configured
3. Single webhook connection between ElevenLabs and n8n is operational
4. Database schemas for 3-tier architecture are created in Supabase
5. Basic voice → n8n → voice round-trip flow is tested and working
6. Development team has access to n8n workflow editor
7. No regression to existing functionality during setup

## Tasks / Subtasks
- [ ] Task 1: n8n Infrastructure Setup (AC: 1, 6)
  - [ ] Choose n8n deployment option (cloud vs self-hosted)
  - [ ] Set up n8n instance with proper authentication
  - [ ] Configure environment variables for n8n
  - [ ] Create team accounts and access permissions
  - [ ] Test n8n workflow editor accessibility
- [ ] Task 2: ElevenLabs Conversational AI Configuration (AC: 2)
  - [ ] Create ElevenLabs Conversational AI account
  - [ ] Configure conversational agent with interview persona
  - [ ] Set up voice settings and conversation parameters
  - [ ] Configure single custom tool for n8n webhook
  - [ ] Document API keys and configuration
- [ ] Task 3: Single Webhook Connection (AC: 3, 5)
  - [ ] Create n8n webhook endpoint for ElevenLabs
  - [ ] Configure ElevenLabs custom tool to call n8n webhook
  - [ ] Test basic request/response flow
  - [ ] Implement simple echo workflow for testing
  - [ ] Verify voice → n8n → voice round-trip works
- [ ] Task 4: Database Schema Implementation (AC: 4)
  - [ ] Create Tier 1: research_data table (90-day retention)
  - [ ] Create Tier 2: assessment_sessions table (active working data)
  - [ ] Create Tier 3: company_business_intel table (permanent storage)
  - [ ] Set up Row Level Security (RLS) policies
  - [ ] Test database connections from n8n
- [ ] Task 5: Basic Integration Testing (AC: 5, 7)
  - [ ] Create "Hello World" n8n workflow for voice interaction
  - [ ] Test conversation initiation through ElevenLabs
  - [ ] Verify n8n can process and respond to voice input
  - [ ] Ensure existing Next.js app remains functional
  - [ ] Document setup process for team reference

## Dev Notes

### n8n + ElevenLabs Architecture Context
[Source: architecture.md#n8n-elevenlabs-integration-architecture]

**Simplified Component Architecture:**
```
ElevenLabs (Voice AI) → n8n (Visual Logic) → Supabase (Data Storage)
                                ↓
                        Next.js (Web UI Only)
```

**Key Architecture Changes:**
- Visual workflow orchestration replaces complex backend code
- Single integration point (one webhook) instead of multiple endpoints
- Clear separation: Voice (ElevenLabs) | Logic (n8n) | UI (Next.js) | Data (Supabase)
- 60% reduction in custom code complexity

### n8n Setup Options
[Source: SCRUM-MASTER-ACTION-ITEMS.md - Infrastructure Setup]

**Cloud (Recommended for Quick Start):**
- n8n Cloud: https://n8n.io
- Instant setup, managed infrastructure
- Built-in scaling and monitoring
- Monthly subscription cost

**Self-Hosted (For Data Control):**
- Docker deployment option
- Full control over data and infrastructure
- No subscription costs (infrastructure costs only)
- Requires DevOps management

### ElevenLabs Configuration
[Source: architecture.md#core-components]

**ElevenLabs Conversational AI Setup:**
- **Single Responsibility:** Manage voice conversations only
- **Configuration:** One custom tool pointing to n8n webhook
- **No business logic:** Pure conversation management
- **Agent persona:** Professional interview consultant

**Custom Tool Configuration:**
```json
{
  "name": "process_conversation",
  "description": "Process user input and generate response",
  "url": "https://your-n8n-instance.com/webhook/interview-orchestrator",
  "method": "POST",
  "headers": {
    "Content-Type": "application/json"
  }
}
```

### Database Schema (3-Tier Architecture)
[Source: architecture.md#database-schema-supabase-postgresql]

**Tier 1: Research Data (Input Layer)**
- Purpose: Raw intelligence from n8n research workflows
- Lifecycle: Generated → Consumed → Archived (90 days)
- Key fields: company_url, research_timestamp, web_scraping_results, etc.

**Tier 2: Assessment Sessions (Working Layer)**
- Purpose: Interview state management and user interaction tracking
- Lifecycle: Created → Updated during interview → Processed → Archived (60 days)
- Key fields: user_id, company_url, current_step, step_data (JSONB)

**Tier 3: Company Business Intelligence (Target Layer)**
- Purpose: Final, validated business intelligence for team collaboration
- Lifecycle: Created from assessment → Team collaboration → Persistent
- Contains all 23 artifacts from assessment

### n8n Workflow Structure
[Source: architecture.md#n8n-orchestration-hub]

**Key Workflows to Create (Story 3.2):**
- Master Orchestrator (routes requests)
- Research Collection (Tier 1 operations)
- Assessment Management (Tier 2 operations)  
- Intelligence Synthesis (Tier 3 operations)

**Basic Test Workflow (This Story):**
```
Webhook Trigger → Process Input → Generate Response → Return to ElevenLabs
```

### Environment Variables Required
```bash
# n8n Configuration
N8N_WEBHOOK_URL="https://your-n8n-instance.com/webhook"
N8N_API_KEY="your-n8n-api-key"

# ElevenLabs Configuration  
ELEVENLABS_CONVERSATIONAL_AI_AGENT_ID="agent-id"
ELEVENLABS_API_KEY="api-key"

# Supabase Configuration
SUPABASE_URL="your-supabase-url"
SUPABASE_ANON_KEY="your-anon-key"
SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"
```

### Success Metrics
[Source: SCRUM-MASTER-ACTION-ITEMS.md - Week 1 Success]

- Basic conversation working through n8n
- Team understands new architecture
- No code regression (old code archived, not deleted)
- Infrastructure foundation ready for workflow development

### File Organization

**New files to create:**
- `/docs/n8n-setup-guide.md` - n8n installation and configuration
- `/docs/elevenlabs-setup-guide.md` - ElevenLabs agent configuration
- `/supabase/migrations/001_three_tier_schema.sql` - Database schema
- `/n8n/workflows/test-echo.json` - Basic test workflow

**Files to update:**
- Environment configuration files
- Documentation index with new architecture

## Testing

### Testing Standards
[Source: architecture/coding-standards.md]

**Week 1 Testing Focus:**
- Infrastructure connectivity testing
- Basic voice flow validation
- Database schema verification
- Team access confirmation

**Specific testing requirements:**
- Test n8n webhook endpoint accessibility
- Verify ElevenLabs can call n8n webhook
- Test database connections from n8n
- Validate voice round-trip latency (<500ms)
- Ensure existing app functionality preserved

**Infrastructure Testing:**
- n8n instance health and accessibility
- ElevenLabs agent configuration validation
- Database schema creation and RLS policies
- Webhook connectivity and response times

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-24 | 1.0 | Initial story creation for n8n + ElevenLabs foundation | Bob 🏃 |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by QA Agent after story completion*