# Story 3.2: n8n Visual Workflows for Business Logic

## Status
Draft

## Story
**As a** development team with n8n infrastructure established,
**I want** to build visual n8n workflows that replace traditional backend code,
**so that** business logic is visual, debuggable, and 60% faster to develop

## Acceptance Criteria
1. Master orchestrator workflow routes conversation requests to appropriate logic
2. Research collection workflows handle Tier 1 data operations and external API calls
3. Assessment management workflows process Tier 2 interview data and state management
4. Synthesis workflows generate business intelligence for Tier 3 storage
5. All workflows execute in <200ms for real-time conversation performance
6. Visual debugging and monitoring are operational for all workflows
7. Workflows handle error scenarios gracefully with retry logic

## Tasks / Subtasks
- [ ] Task 1: Master Orchestrator Workflow (AC: 1)
  - [ ] Create main routing workflow that receives ElevenLabs webhook calls
  - [ ] Implement request parsing and conversation context analysis
  - [ ] Route to appropriate sub-workflows based on conversation state
  - [ ] Handle session management and state persistence
  - [ ] Return formatted responses to ElevenLabs agent
- [ ] Task 2: Research Collection Workflows (AC: 2)
  - [ ] Build company research workflow using external APIs
  - [ ] Create web scraping and data enrichment sub-workflows
  - [ ] Implement Tier 1 data storage operations
  - [ ] Add confidence scoring and data validation
  - [ ] Create research completion notification workflow
- [ ] Task 3: Assessment Management Workflows (AC: 3)
  - [ ] Create Step 1 assessment workflow (Core Identity & Business Model)
  - [ ] Create Step 2 assessment workflow (Customer & Market Intelligence)
  - [ ] Build dynamic question generation workflows
  - [ ] Implement step_data JSONB update operations
  - [ ] Add artifact completion tracking and validation
- [ ] Task 4: Synthesis Workflows (AC: 4)
  - [ ] Create data synthesis workflow (Tier 2 â†’ Tier 3)
  - [ ] Build business intelligence generation sub-workflows
  - [ ] Implement 23-artifact report compilation
  - [ ] Add team collaboration and access control
  - [ ] Create notification workflows for assessment completion
- [ ] Task 5: Performance Optimization & Error Handling (AC: 5, 7)
  - [ ] Optimize all workflows for <200ms execution time
  - [ ] Implement error handling and retry logic
  - [ ] Add workflow monitoring and performance tracking
  - [ ] Create fallback mechanisms for external API failures
  - [ ] Test concurrent workflow execution under load

## Dev Notes

### Visual Workflow Architecture
[Source: architecture.md#architectural-patterns]

**Visual Workflow Orchestration:** n8n serves as the visual business logic layer
**Rationale:** Interview flows are inherently visual, drag-and-drop modifications without code deployment

**Key Benefits:**
- 60% faster development than traditional code
- Visual debugging and data flow inspection
- Business-friendly workflow modifications
- No deployment needed for logic changes

### Workflow Structure Overview
[Source: architecture.md#n8n-orchestration-hub]

**Key Workflows:**
- **Master Orchestrator:** Routes requests and manages conversation flow
- **Research Collection:** Tier 1 operations (external APIs, data enrichment)
- **Assessment Management:** Tier 2 operations (interview logic, state management)
- **Intelligence Synthesis:** Tier 3 operations (report generation, business intelligence)

### Master Orchestrator Workflow Design

**Flow Structure:**
```
ElevenLabs Webhook â†’ Parse Request â†’ Determine Action â†’ Route to Sub-workflow â†’ Format Response â†’ Return
```

**Routing Logic:**
- **Research Phase:** Route to research collection workflows
- **Assessment Phase:** Route to appropriate step assessment workflow
- **Synthesis Phase:** Route to intelligence generation workflows
- **Error/Unknown:** Route to fallback response workflow

**Session Management:**
- Load session state from Supabase
- Maintain conversation context across workflow calls
- Update session state based on workflow results
- Handle session recovery and timeout scenarios

### Research Collection Workflows
[Source: architecture.md#tier-1-research-data]

**Company Research Workflow:**
1. **Input:** Company URL from user
2. **Process:** Web scraping, API calls, data enrichment
3. **Output:** Structured research data to Tier 1 (research_data table)

**Sub-workflows:**
- Website content extraction
- Social media analysis
- Financial data gathering
- News and press coverage
- Competitive intelligence
- Industry analysis and trends

**External API Integration:**
- Configure HTTP request nodes for various APIs
- Implement rate limiting and retry logic
- Add data transformation and normalization
- Store raw and processed data separately

### Assessment Management Workflows
[Source: PRD.md#official-assessment-structure]

**Step 1 Assessment Workflow (Core Identity & Business Model):**
- Artifact 1: Company Mission & Vision
- Artifact 2: Core Offering Definition
- Artifact 3: Regulatory Pathway (MedTech)
- Artifact 4: Revenue Streams & Pricing

**Step 2 Assessment Workflow (Customer & Market Intelligence):**
- Artifact 5: Market Sizing (TAM, SAM, SOM)
- Artifact 6: Clinical Evidence & KOL Strategy
- Artifact 7: Ideal Customer Profile
- Artifact 8: Customer Pains & Gains

**Workflow Components:**
- Question generation based on research gaps
- User response processing (confirmations, corrections, additions)
- step_data JSONB structure updates
- Completion status tracking
- Dynamic conversation flow management

### step_data JSONB Structure in Workflows
[Source: architecture.md#tier-2-assessment-interview-data]

**n8n JSONB Operations:**
```json
{
  "step_1_core_identity": {
    "artifacts": {
      "artifact_1_company_mission_vision": {
        "research_input": "{{$node.Research.json.mission_data}}",
        "user_confirmations": "{{$node.UserInput.json.confirmations}}",
        "user_corrections": "{{$node.UserInput.json.corrections}}",
        "user_additions": "{{$node.UserInput.json.additions}}",
        "completion_status": "{{$node.Validation.json.status}}"
      }
    }
  }
}
```

### Synthesis Workflows
[Source: architecture.md#tier-3-company-business-intelligence]

**Data Synthesis Process:**
1. **Trigger:** Assessment session marked as completed
2. **Input:** Validated Tier 2 assessment data
3. **Process:** Combine research + confirmations + corrections + additions
4. **Output:** Final business intelligence for Tier 3

**Business Intelligence Generation:**
- Resolve conflicts (user corrections > research data)
- Generate confidence scores for each artifact
- Create comprehensive 23-artifact report
- Add team collaboration metadata
- Notify stakeholders of completion

### Performance Requirements
[Source: SCRUM-MASTER-ACTION-ITEMS.md - Week 2 Success]

**Target Metrics:**
- **Workflow execution:** <200ms per workflow
- **Total conversation response:** <500ms end-to-end
- **Database operations:** <100ms for JSONB updates
- **External API calls:** <300ms with timeout handling

**Optimization Strategies:**
- Parallel workflow execution where possible
- Database connection pooling
- Caching frequently accessed data
- Lazy loading of large datasets

### Error Handling and Resilience

**Retry Logic:**
- External API failures: 3 retries with exponential backoff
- Database connection issues: Automatic retry with circuit breaker
- ElevenLabs webhook timeouts: Graceful fallback responses

**Fallback Mechanisms:**
- API unavailable: Use cached/default responses
- Database issues: Store in temporary workflow memory
- Workflow errors: Return helpful error message to user

### Workflow File Organization

**n8n Workflow Export Structure:**
```
/n8n/workflows/
â”œâ”€â”€ master-orchestrator.json
â”œâ”€â”€ research/
â”‚   â”œâ”€â”€ company-research.json
â”‚   â”œâ”€â”€ competitive-analysis.json
â”‚   â””â”€â”€ industry-analysis.json
â”œâ”€â”€ assessment/
â”‚   â”œâ”€â”€ step-1-core-identity.json
â”‚   â”œâ”€â”€ step-2-customer-market.json
â”‚   â””â”€â”€ question-generation.json
â””â”€â”€ synthesis/
    â”œâ”€â”€ data-synthesis.json
    â”œâ”€â”€ report-generation.json
    â””â”€â”€ team-notification.json
```

### Visual Debugging Features
[Source: SCRUM-MASTER-ACTION-ITEMS.md - Visual Logic]

**n8n Debugging Capabilities:**
- Real-time execution visualization
- Node-by-node data inspection
- Execution history and logs
- Performance timing per node
- Error highlighting and stack traces

**Monitoring Setup:**
- Workflow execution metrics
- Performance bottleneck identification
- Error rate tracking per workflow
- Success/failure notifications

### Integration with Existing Code
[Source: SCRUM-MASTER-ACTION-ITEMS.md - Frontend team: Remove conversation logic]

**Code Reuse Strategy:**
- Assessment logic templates can be adapted to n8n
- Question generation patterns transferred to visual workflows
- Database schema remains unchanged
- API endpoints replaced by n8n HTTP nodes

**Next.js Integration:**
- Remove conversation orchestration code
- Keep data display and UI components
- Add real-time workflow status monitoring
- Maintain authentication and session management

## Testing

### Testing Standards
[Source: architecture/coding-standards.md]

**Week 2 Testing Focus:**
- Visual workflow functionality testing
- Performance benchmarking (<200ms target)
- Error handling and recovery testing
- Data flow validation through all tiers

**Specific testing requirements:**
- Test each workflow individually with mock data
- End-to-end flow testing with real ElevenLabs integration
- Database operations testing with JSONB structure
- Concurrent workflow execution testing
- External API failure simulation and recovery

**Visual Workflow Testing:**
- n8n test workflow execution
- Manual testing through n8n interface
- Automated webhook testing for all workflows
- Performance monitoring during test execution

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-24 | 1.0 | Initial story creation for n8n core workflows | Bob ðŸƒ |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by QA Agent after story completion*