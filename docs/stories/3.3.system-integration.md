# Story 3.3: ElevenLabs, n8n, and Next.js System Integration

## Status
Draft

## Story
**As a** development team with n8n workflows operational,
**I want** to integrate ElevenLabs, n8n, and Next.js into a cohesive system,
**so that** users experience seamless voice conversations with real-time progress tracking

## Acceptance Criteria
1. ElevenLabs agent is configured with single custom tool pointing to n8n master orchestrator
2. Next.js UI displays real-time progress and conversation status from n8n workflows
3. Database operations work flawlessly through n8n with proper error handling
4. Error handling and recovery mechanisms are tested and operational
5. Full conversation flow works end-to-end: voice input → n8n logic → database updates → voice response
6. User interface is simplified to display-only (no conversation orchestration code)
7. System performance meets targets: <500ms total response time

## Tasks / Subtasks
- [ ] Task 1: ElevenLabs Custom Tool Configuration (AC: 1)
  - [ ] Configure ElevenLabs agent with single custom tool for n8n
  - [ ] Set up conversation parameters and voice settings
  - [ ] Implement proper authentication between ElevenLabs and n8n
  - [ ] Test custom tool invocation and response handling
  - [ ] Document ElevenLabs agent configuration for team
- [ ] Task 2: Next.js UI Simplification and Real-Time Updates (AC: 2, 6)
  - [ ] Remove conversation orchestration code from Next.js
  - [ ] Implement real-time progress tracking from n8n workflows
  - [ ] Create simplified UI components for assessment progress display
  - [ ] Add WebSocket or SSE connections for live workflow updates
  - [ ] Update interview interface to display-only mode
- [ ] Task 3: Database Operations Integration (AC: 3)
  - [ ] Configure n8n database connections for all three tiers
  - [ ] Test JSONB operations for assessment step_data updates
  - [ ] Implement connection pooling and performance optimization
  - [ ] Add database operation monitoring and logging
  - [ ] Ensure Row Level Security policies work with n8n operations
- [ ] Task 4: Error Handling and Recovery Systems (AC: 4)
  - [ ] Implement comprehensive error handling in n8n workflows
  - [ ] Create fallback mechanisms for external API failures
  - [ ] Add retry logic with exponential backoff for failed operations
  - [ ] Build error notification and alerting system
  - [ ] Test recovery scenarios and failover procedures
- [ ] Task 5: End-to-End Integration Testing (AC: 5, 7)
  - [ ] Test complete conversation flow from voice input to database storage
  - [ ] Verify real-time UI updates during conversation progression
  - [ ] Performance testing to meet <500ms response time target
  - [ ] Load testing with multiple concurrent conversations
  - [ ] User acceptance testing with complete assessment scenarios

## Dev Notes

### System Integration Architecture
[Source: architecture.md#simplified-component-architecture]

**Final System Flow:**
```
User Voice → ElevenLabs → n8n Workflows → Supabase Database
                              ↓
                         Next.js UI (Display Only)
```

**Integration Points:**
- **ElevenLabs ↔ n8n:** Single webhook with custom tool
- **n8n ↔ Supabase:** Direct database operations
- **n8n ↔ Next.js:** Real-time progress updates
- **Next.js ↔ Supabase:** Read-only data display

### ElevenLabs Custom Tool Configuration
[Source: architecture.md#elevenlabs-conversational-ai]

**Single Custom Tool Setup:**
```json
{
  "name": "process_interview_conversation",
  "description": "Process user conversation and manage interview flow",
  "url": "https://your-n8n.com/webhook/master-orchestrator",
  "method": "POST",
  "headers": {
    "Authorization": "Bearer your-n8n-webhook-token",
    "Content-Type": "application/json"
  },
  "parameters": {
    "conversation_context": {
      "type": "object",
      "description": "Current conversation context and user input"
    },
    "session_id": {
      "type": "string", 
      "description": "Unique session identifier for conversation tracking"
    }
  }
}
```

**ElevenLabs Agent Configuration:**
- Voice settings optimized for professional interviews
- Conversation parameters for natural flow
- Context window sized for full assessment conversations
- Interruption handling enabled for natural interactions

### Next.js UI Simplification
[Source: SCRUM-MASTER-ACTION-ITEMS.md - Frontend team: Remove conversation logic]

**Remove These Components:**
- Interview orchestration logic
- Voice Agent classes
- Data Validation Agent code
- Complex conversation state management

**Keep These Components:**
- User authentication and session management
- Assessment progress display
- Real-time status updates
- Research summary display
- Final report generation and viewing

**New Components to Add:**
- Real-time workflow status display
- n8n workflow execution progress
- Live conversation transcript (optional)
- Error state handling for workflow failures

### Real-Time Progress Tracking

**Implementation Options:**
1. **WebSocket Connection:** Direct connection to n8n for real-time updates
2. **Server-Sent Events (SSE):** One-way updates from n8n to Next.js
3. **Polling:** Regular status checks from Next.js to n8n
4. **Supabase Realtime:** Database change subscriptions

**Recommended Approach: Supabase Realtime**
```typescript
// Subscribe to assessment session changes
const subscription = supabase
  .from('assessment_sessions')
  .on('UPDATE', payload => {
    // Update UI with latest progress
    setAssessmentProgress(payload.new);
  })
  .subscribe();
```

### Database Integration Through n8n
[Source: architecture.md#three-tier-data-architecture]

**n8n Database Nodes Configuration:**
- **Postgres Node:** Direct connections to Supabase
- **Connection Pooling:** Optimize for concurrent operations
- **JSONB Operations:** step_data structure updates
- **RLS Compliance:** Ensure security policies are respected

**Database Operations Patterns:**
```
n8n Workflow → Postgres Node → JSONB Update → Success Response
                    ↓
             Error Handler → Retry Logic → Fallback Response
```

### Error Handling and Recovery
[Source: SCRUM-MASTER-ACTION-ITEMS.md - Risk Assessment]

**Error Handling Layers:**
1. **n8n Workflow Level:** Try-catch blocks and error nodes
2. **ElevenLabs Level:** Graceful conversation recovery
3. **Database Level:** Transaction rollback and retry
4. **UI Level:** User-friendly error messages

**Recovery Scenarios:**
- **n8n Workflow Failure:** Return error message to ElevenLabs, log incident
- **Database Connection Loss:** Queue operations, retry when available
- **ElevenLabs Timeout:** Store conversation state, allow reconnection
- **External API Failure:** Use cached data or gracefully skip

### Performance Optimization
[Source: SCRUM-MASTER-ACTION-ITEMS.md - Week 3 Success]

**Performance Targets:**
- **Total Response Time:** <500ms end-to-end
- **n8n Workflow Execution:** <200ms per workflow
- **Database Operations:** <100ms for JSONB updates
- **UI Updates:** <50ms for real-time progress changes

**Optimization Strategies:**
- n8n workflow performance tuning
- Database query optimization
- Connection pooling and caching
- Parallel processing where possible

### Conversation Flow Integration

**Complete Flow Example:**
1. **User speaks:** "I want to start an assessment"
2. **ElevenLabs processes:** Transcribes and analyzes intent
3. **Custom tool calls n8n:** Sends conversation context
4. **n8n master orchestrator:** Routes to appropriate workflow
5. **Assessment workflow:** Processes request, updates database
6. **n8n returns response:** Formatted message for ElevenLabs
7. **ElevenLabs responds:** Natural voice response to user
8. **Next.js UI updates:** Shows progress in real-time

### Simplified UI Architecture

**Before (Complex):**
```typescript
// Multiple agent classes and complex orchestration
class InterviewOrchestrator { ... }
class VoiceAgent { ... }
class DataValidationAgent { ... }
```

**After (Simplified):**
```typescript
// Simple display components and data fetching
function AssessmentProgress({ sessionId }) {
  const { data, error } = useRealtimeSession(sessionId);
  return <ProgressDisplay data={data} />;
}
```

### Authentication and Security

**Authentication Flow:**
- Next.js handles user authentication (Supabase Auth)
- Session tokens passed to n8n for database operations
- Row Level Security enforced at database level
- ElevenLabs webhook secured with authentication tokens

**Security Considerations:**
- n8n webhook authentication
- Database connection security
- User session validation
- Data privacy and retention policies

### File Organization

**Files to modify:**
- `/components/interview/*` - Simplify to display-only components
- `/lib/interview/*` - Remove orchestration code, keep data types
- `/app/interview/*` - Simplify page components
- Environment configuration for n8n integration

**Files to create:**
- `/lib/n8n-integration.ts` - n8n API client
- `/components/realtime/WorkflowStatus.tsx` - Real-time progress display
- `/hooks/useRealtimeSession.ts` - Supabase realtime hook
- `/docs/system-integration-guide.md` - Integration documentation

## Testing

### Testing Standards
[Source: architecture/coding-standards.md]

**Week 3 Testing Focus:**
- End-to-end integration testing
- Real-time UI updates validation
- Error handling and recovery testing
- Performance benchmarking

**Specific testing requirements:**
- Complete conversation flow testing with real voice input
- Database operations testing through n8n
- Real-time UI update responsiveness testing
- Error scenario simulation and recovery validation
- Load testing with multiple concurrent users

**Integration Testing Scenarios:**
- New user starts assessment conversation
- User completes Step 1, progresses to Step 2
- User interrupts conversation and resumes later
- System handles n8n workflow errors gracefully
- Real-time UI shows accurate progress throughout

**Performance Testing:**
- Measure end-to-end response times
- Test concurrent conversation handling
- Database performance under load
- UI responsiveness during heavy usage

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-24 | 1.0 | Initial story creation for system integration | Bob 🏃 |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by QA Agent after story completion*