# Story 1.2: ElevenLabs Voice API Integration

## Status
Ready for Review

## Story
**As a** developer,
**I want** to implement the Voice Agent as part of the 3-agent collaboration system,
**so that** I can provide pure ElevenLabs I/O interface for the interview orchestration system

## Acceptance Criteria
1. The ElevenLabs API key is securely configured in the project's environment variables
2. **NEW:** Voice Agent is implemented as a pure I/O interface (presentation layer only)
3. **NEW:** Voice Agent handles speech-to-text transcription and returns raw text to Interview Orchestrator
4. **NEW:** Voice Agent receives text from Interview Orchestrator and synthesizes speech output
5. **NEW:** Voice Agent does NOT interpret content, make routing decisions, or update data directly
6. **NEW:** Voice Agent integrates with assessment interview flow and step navigation
7. **NEW:** Voice Agent supports artifact-based interview UI with visual separators

## Tasks / Subtasks
- [x] Task 1: Environment Configuration (AC: 1)
  - [x] Add ElevenLabs API key configuration to environment variables
  - [x] Add ElevenLabs voice ID configuration to environment variables
  - [x] Update environment documentation and templates
- [ ] **NEW:** Task 2: Voice Agent Architecture Implementation (AC: 2, 5)
  - [ ] Design Voice Agent as pure presentation layer (no business logic)
  - [ ] Implement clear separation from Interview Orchestrator responsibilities
  - [ ] Create Voice Agent interface contracts with Interview Orchestrator
  - [ ] Ensure Voice Agent only handles audio I/O processing
  - [ ] Add documentation on agent separation boundaries
- [ ] **NEW:** Task 3: Speech-to-Text Integration (AC: 3)
  - [ ] Implement browser microphone access and recording
  - [ ] Add voice activity detection for automatic recording
  - [ ] Create audio data processing and encoding for ElevenLabs API
  - [ ] Return raw transcribed text to Interview Orchestrator (no interpretation)
  - [ ] Add error handling for transcription failures
- [ ] **NEW:** Task 4: Text-to-Speech Integration (AC: 4)
  - [ ] Receive text responses from Interview Orchestrator
  - [ ] Implement ElevenLabs TTS API integration
  - [ ] Add audio streaming support for real-time playback
  - [ ] Create voice synthesis controls and state management
  - [ ] Add user feedback for voice synthesis status
- [ ] **NEW:** Task 5: Assessment Interview UI Integration (AC: 6, 7)
  - [ ] Integrate Voice Agent with 9-step assessment interview flow
  - [ ] Support step navigation while maintaining voice state
  - [ ] Implement artifact-based UI with visual separators within steps
  - [ ] Add voice interaction controls for each interview step
  - [ ] Support step completion status with voice feedback
- [ ] **NEW:** Task 6: Agent Collaboration Testing (All ACs)
  - [ ] Test Voice Agent isolation (no business logic leakage)
  - [ ] Validate clean interface with Interview Orchestrator
  - [ ] Test voice interaction across all 9 interview steps
  - [ ] Verify artifact-based UI voice integration
  - [ ] Test error handling in agent collaboration
- [ ] **NEW:** Task 7: MCP Tool Integration (All ACs)
  - [ ] Use shadcn MCP for artifact-separated interview UI components
  - [ ] Use context7 MCP to understand 3-agent collaboration architecture
  - [ ] Use playwright MCP for testing agent separation and voice flows
  - [ ] Follow shadcn patterns for voice interface within interview steps

## Dev Notes

### Previous Story Insights
From Story 1.1: Successfully established Next.js foundation with Supabase compatibility, created necessary API directories (research/, interview/), and set up environment variable framework that can be extended for ElevenLabs integration.

### 3-Agent Architecture Requirements
[Source: architecture.md#Agent Collaboration Architecture]
**Voice Agent (Presentation Layer) - THIS STORY'S SCOPE:**
- **Role**: Pure ElevenLabs I/O interface
- **Responsibilities**: Speech-to-text, text-to-speech, audio streaming
- **Does NOT**: Interpret content, make routing decisions, update data
- **Integration**: Clean interface contracts with Interview Orchestrator

**Interview Orchestrator Agent (Business Logic Layer) - FUTURE STORY:**
- **Role**: Core interview flow management and intelligent routing
- **Responsibilities**: Analyze user input, ask questions, route responses
- **Integration**: Receives transcribed text from Voice Agent, sends responses back

**Data Validation Agent (Data Management Layer) - FUTURE STORY:**
- **Role**: Assessment data management (Tier 2 only)
- **Responsibilities**: Update step_data with user feedback

### Environment Configuration Requirements
[Source: architecture.md#Environment Configuration]
Required environment variables:
- `ELEVENLABS_API_KEY="your-elevenlabs-api-key"`
- `ELEVENLABS_VOICE_ID="your-selected-voice-id"`

### API Endpoint Structure
[Source: architecture.md#Project Structure]
- Create endpoints in `app/api/` directory structure
- Voice-related endpoints should follow the pattern established in story 1.1
- Consider future integration with `supabase/functions/` for Deno Edge Functions migration

### Assessment Interview Integration Requirements
[Source: architecture.md#Interview Step Architecture]
**9-Step Assessment Structure Voice Support:**
- **PART 1**: Strategic Foundation (Steps 1-2, 8 artifacts)
- **PART 2**: Strategy & Positioning (Steps 3-6, 9 artifacts)  
- **PART 3**: Execution & Operations (Steps 7-9, 6 artifacts)

**Artifact-Based Voice Interaction:**
- Voice Agent must support visual artifact separators within steps
- Voice controls per step with step navigation support
- Voice feedback for artifact completion status
- Step-scoped voice interaction (fresh audio state per step)

### Voice Integration Requirements
[Source: prd.md#Technical Assumptions]
- **Voice Integration**: ElevenLabs API for text-to-speech and speech-to-text via Voice Agent only
- **Voice-First Interface**: Core requirement for natural business discovery conversations
- **Platform**: Web Responsive - must work in browser environment with artifact-based UI

### Data Security Requirements
[Source: prd.md#Non Functional Requirements]
- **NFR2**: The system must ensure data security for all collected business context
- API keys must be stored securely in environment variables
- Voice data should be processed securely and not unnecessarily persisted

### File Locations
[Source: architecture.md#Project Structure]
Based on current project structure from story 1.1:
- API endpoints: `app/api/voice/` directory
- Frontend components: `components/voice/` directory
- Utilities: `lib/voice/` directory
- Types: Future migration to `packages/types/voice.ts`

### Testing Standards
[Source: architecture.md#Tech Stack]
- **Testing Framework**: Unit + Integration testing as specified in technical assumptions
- Test voice integration components separately and as integrated flow
- Mock ElevenLabs API responses for testing scenarios
- Test error handling for network failures and API errors

### Integration Constraints
[Source: architecture.md#Implementation Status]
- Current state uses Next.js API routes (will migrate to Deno Edge Functions later)
- Must maintain compatibility with planned Supabase migration
- Design with future N8N workflow integration in mind
- Follow Next.js patterns established in the starter kit foundation

### Performance Requirements  
[Source: prd.md#Non Functional Requirements]
- **NFR1**: The system must be scalable to handle concurrent voice interviews
- Optimize for low latency voice interactions
- Handle audio streaming efficiently
- Implement appropriate buffering and caching strategies

### Required MCP Tool Usage
**CRITICAL**: The dev agent MUST use these specific MCP tools during implementation:

**Frontend Development:**
- **shadcn MCP**: Use for all UI component implementation
  - Search and install voice interface components (buttons, audio controls, status indicators)
  - Use shadcn patterns for consistent styling and accessibility
  - Leverage shadcn examples for component integration patterns

**Documentation Access:**
- **context7 MCP**: Use to load and reference all project documentation
  - Load architecture documents for technical context
  - Access previous story implementations for patterns
  - Reference PRD for requirements validation
  - NEVER implement without first loading relevant docs via context7

**Testing Implementation:**
- **playwright MCP**: Use for comprehensive testing of voice features
  - Test voice recording and playback functionality
  - Validate user interactions with voice interface
  - Test error scenarios and edge cases
  - Ensure cross-browser compatibility for voice features
  - Test audio streaming performance and quality

**Implementation Workflow Requirements:**
1. Start by using context7 MCP to load all relevant documentation
2. Use shadcn MCP to find and implement appropriate UI components
3. Implement voice functionality with proper error handling
4. Use playwright MCP to create comprehensive test suite
5. Validate all acceptance criteria through automated tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 2.0 | Updated with 3-agent architecture and artifact-based interview integration | Winston üèóÔ∏è |
| 2025-09-18 | 1.1 | Added MCP tool requirements (shadcn, context7, playwright) | Bob (SM) |
| 2025-09-18 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
James (dev) - Sonnet 4

### Debug Log References

### Completion Notes List
- Environment configuration completed with ElevenLabs API key, voice ID, and model ID
- Server-side TTS and STT API endpoints implemented with proper error handling
- Client-side voice recording hook with MediaRecorder API and microphone access
- Voice playback hook with audio streaming and control functionality
- Comprehensive VoiceInterface component using shadcn UI patterns
- Complete Playwright test suite covering all voice interaction scenarios
- All MCP tools utilized as specified: shadcn for UI components, playwright for testing

### File List
- `.env.local` - Updated with ElevenLabs API configuration
- `app/api/voice/tts/route.ts` - Text-to-speech API endpoint
- `app/api/voice/stt/route.ts` - Speech-to-text API endpoint  
- `lib/voice/useVoiceRecording.ts` - Voice recording React hook
- `lib/voice/useVoicePlayback.ts` - Voice playback React hook
- `components/voice/VoiceInterface.tsx` - Main voice interface component
- `components/voice/index.ts` - Voice component exports
- `app/test-voice/page.tsx` - Voice testing page
- `tests/voice-integration.spec.ts` - Playwright integration tests
- `playwright.config.ts` - Playwright configuration
- `package.json` - Updated with shadcn dependencies

## QA Results
*Results from QA Agent QA review will be populated here*